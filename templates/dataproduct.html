{% extends base.html %}

{% block title %}
  Dispatch Directions  
{% end %}

{% block local_css %}
  <style type="text/css">
    html { height: 100% }
    body { height: 100%; margin: 0px; padding: 0px }
    #map_canvas { 
      width: 85%;
      height: 70%;
      margin-left: auto;
      margin-right: auto;}
    #directions_panel { 
      width: 85%;
      height: 25%;
      margin-left: auto;
      margin-right: auto;}
  </style>
{% end %}

{% block local_js %}
  <script type="text/javascript"
      src="http://maps.google.com/maps/api/js?sensor=false">
  </script>
  <script type="text/javascript"
      src="{{ static_url("underscore/underscore.js") }}">
  </script>
  <script type="text/javascript"
      src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.js">
  </script>
  <script type="text/javascript">

    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;
    var incidents = new Array();
    var markers = new Array();
    var fireStations;
    var policeStations;
    var closestStation;
    var closestDistance;
    var distances = new Array();
    var seattle = new google.maps.LatLng(47.629, -122.330);

    function Incident(location, distance, incident, dayOfWeek) {
      this.location = location;
      this.distance = distance;
      this.incident = incident;
      this.dayOfWeek = dayOfWeek;
    }

    Array.prototype.sortStationsByDistance = function() {
      return this.sort(function(a,b) { return a.distance - b.distance; });
    }

    // TODO: move this stuff into another js file http://www.dustindiaz.com/namespace-your-javascript/
    function fetchCoords(data_endpoint) {
      var features;
      var req = new XMLHttpRequest();
      req.open('GET', data_endpoint, false);
      req.send(null);
      if (req.status == 200) {
         console.log(req.responseText);
         coords = eval('(' + req.responseText + ')');
         return coords;
      }
      else
        console.log("Error loading page\n");
    }

    function addMarker(position, map, image) {
      var marker = new google.maps.Marker({
          position: position,
          animation: google.maps.Animation.DROP,
          map: map,
          icon: image
      });
    }

    function addMarkerHelper(position, map, image) {
      return function() {
        addMarker(position, map, image);
      }   
    }

    function dropMarkers(positionArray, map, image) {
      for (var i = 0; i < positionArray.length; i++) {
        setTimeout(addMarkerHelper(positionArray[i], map, image), i * 200);
      }
    }

    // Deletes all markers in the array by removing references to them
    function deleteMarkers() {
      if (markers) {
        var numMarkers = markers.length;
        for (var i = 0; i < numMarkers; i++) {
          markers[i].setMap(null);
        }
        markers.length = 0;
      }
    }

    function resetMap() {
      var blank_result = new Object();
      blank_result.routes = new Array();
      deleteMarkers();
      incidents.length = 0;
      directionsDisplay.setDirections(blank_result);
      map.setCenter(seattle);
      map.setZoom(11); 
    }

    function getDirectionsRequest(origin, destination, options) {
      var waypoints;
      if (options['waypoints'])
        waypoints = _.map(options['waypoints'], function(wp) {
            return { 
              location: new google.maps.LatLng(wp[0], wp[1]),
              stopover: true
            };
        });
      else
        waypoints = new Array();

      var request = {
        origin: origin, 
        destination: destination,
        waypoints: waypoints,
        provideRouteAlternatives: false,
        travelMode: google.maps.DirectionsTravelMode.DRIVING,
        unitSystem: google.maps.DirectionsUnitSystem.IMPERIAL
      }
      return request;
    }

    function getDistance(origin, destination, options) {
      var request = getDirectionsRequest(origin, destination, options);
      directionsService.route(request, function(result, status) {
         if (status == google.maps.DirectionsStatus.OK) {
           var distance = result.routes[0].legs[0].distance.value;
           return distance;
         }
         else {
           // TODO: log this on the screen somehow
           console.log(status);
         }
      });
    }

    function updateDirections(newOrigin, newDestination, newOptions) {
      var request = getDirectionsRequest(newOrigin, newDestination, newOptions);
      directionsService.route(request, function(result, status) {
         if (status == google.maps.DirectionsStatus.OK) {
           directionsDisplay.setDirections(result);
         }
         else {
           // TODO: log this on the screen somehow
           console.log(status);
         }
      });
    }

    function getClosestPoliceStation(location) {
      function getClosestSleeperCallback() {
        distances.sortStationsByDistance();
        var closestStation = distances[0].station;
        updateDirections(closestStation, location, {});
      }
      numPoliceStations = policeStations.length; 

      closestDistance = Number.MAX_VALUE;
      distances.length = 0;

      var getClosestSleeper = _.after(numPoliceStations, getClosestSleeperCallback);
      _.each(policeStations, function(station, index) {
        var request = getDirectionsRequest(station, location, {});
        directionsService.route(request, function(result, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            var distance = result.routes[0].legs[0].distance.value;
            distances[index] = { distance: distance, station: station };
            getClosestSleeper();
          }
          else {
            // TODO: log this on the screen somehow
            console.log(status);
          }
        });
      });
    }

    function addIncident(location, map) {
      var marker = new google.maps.Marker({
          position: location, 
          map: map
      });
      markers.push(marker);

      if (incidents.length == 0) {
        newIncident = new Incident(location, 5, "hate crime", "monday");
        incidents.push(newIncident);
        getClosestPoliceStation(location);
      }
      else {
        // TODO: push/add stuff in order of priority (need to determine)
        console.log("IMPLEMENT ME");
      }
    }

    function initialize() {

      var mapOptions = {
        zoom: 11,
        center: seattle,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
      };

      map = new google.maps.Map(document.getElementById("map_canvas"),
          mapOptions);

      // TODO: load fire stations too
      policeCoords = fetchCoords('data/police_stations.json');
      policeStations = _.map(policeCoords, function(coord) {
          return new google.maps.LatLng(coord[0], coord[1]);
      });
      dropMarkers(policeStations, map, '{{ static_url("images/police_station.png") }}');

      google.maps.event.addListener(map, 'click', function(event) {
        addIncident(event.latLng, map);
      });
      
      directionsDisplay = new google.maps.DirectionsRenderer();
      directionsDisplay.setMap(map);
      directionsDisplay.setPanel(document.getElementById("directions_panel"));
    }

  </script>
{% end %}

{% block content %}
  <body onload="initialize()">
    <h1>Dispatch Directions</h1>
    <div id="map_canvas"></div>
    <button type="reset" onclick="resetMap()">Reset</button>
    <div id="directions_panel"></div>
  </body>
{% end %}
